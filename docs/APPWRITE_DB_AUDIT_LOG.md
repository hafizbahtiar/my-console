# Appwrite Database: Audit Logs Collection

This document details the setup and configuration of the `audit_logs` collection in your Appwrite database. This collection is essential for tracking user activities, security events, and system operations in your My Console application.

## Prerequisites

Before setting up the audit logs collection, ensure you have:

- ‚úÖ [Appwrite project configured](../APPWRITE_SETUP.md#appwrite-project-setup)
- ‚úÖ [Database created](../APPWRITE_SETUP.md#database-setup)
- ‚úÖ Appwrite JavaScript SDK installed
- ‚úÖ Environment variables configured

## Collection Setup

### Create Audit Logs Collection

1. Go to **Database** in your Appwrite console
2. Select your database (`console-db`)
3. Click **Create Collection**
4. Set Collection ID: `audit_logs`
5. Set Collection Name: `Audit Logs`
6. Set Permissions: **Document Level** (more secure)

### Required Attributes

| Attribute | Type | Size | Required | Description |
|-----------|------|------|----------|-------------|
| `userId` | `string` | 128 | ‚úÖ | User who performed the action |
| `action` | `string` | 50 | ‚úÖ | Action performed (e.g., USER_LOGIN, PROFILE_UPDATE) |
| `resource` | `string` | 50 | ‚úÖ | Resource affected (e.g., auth, user_profile) |
| `resourceId` | `string` | 128 | ‚ùå | ID of the affected resource |
| `$createdAt` | `datetime` | - | üîÑ | Auto-generated timestamp (when action occurred) |
| `oldValues` | `string` | 5000 | ‚ùå | Previous values (JSON string) |
| `newValues` | `string` | 5000 | ‚ùå | New values (JSON string) |
| `ipAddress` | `string` | 45 | ‚ùå | User's IP address |
| `userAgent` | `string` | 500 | ‚ùå | Browser user agent |
| `sessionId` | `string` | 128 | ‚ùå | Session identifier |
| `metadata` | `string` | 2000 | ‚ùå | Additional context (JSON string) |

### Indexes (for efficient querying)

Create the following indexes for optimal performance:

1. **user_created_index**: `userId` (Key) + `$createdAt` (descending)
2. **action_created_index**: `action` (Key) + `$createdAt` (descending)
3. **resource_created_index**: `resource` (Key) + `$createdAt` (descending)

### Collection Permissions

Set the following permissions for the audit_logs collection:

**Read Access:**
- `role:all` - Allow reading audit logs (for admins)
- `users` - Allow users to read their own logs

**Write Access:**
- `role:all` - Allow system to write audit logs

**Update/Delete Access:**
- `role:all` - Allow admins to manage audit logs

## Data Structure

### AuditLogEntry Interface

```typescript
interface AuditLogEntry {
  // Required fields
  userId: string           // User who performed the action
  action: string          // Action performed (USER_LOGIN, PROFILE_UPDATE, etc.)
  resource: string        // Resource affected (auth, user_profile, security)

  // Optional contextual fields
  resourceId?: string     // ID of the affected resource
  oldValues?: Record<string, any>  // Previous values (JSON serialized)
  newValues?: Record<string, any>  // New values (JSON serialized)
  ipAddress?: string      // User's IP address
  userAgent?: string      // Browser user agent
  sessionId?: string      // Session identifier
  metadata?: Record<string, any>  // Additional context (JSON serialized)

  // System fields (auto-populated)
  id?: string            // Auto-generated by Appwrite
  $createdAt?: string    // Timestamp when action occurred
  $updatedAt?: string    // Auto-updated by Appwrite
}
```

### Predefined Audit Events

The application uses these standardized event types:

- **USER_LOGIN**: User successfully logged in
- **USER_LOGOUT**: User logged out
- **PROFILE_UPDATE**: User profile modified
- **SECURITY_EVENT**: Security-related events (failed logins, suspicious activity)
- **SYSTEM_EVENT**: System-level events (backups, maintenance)

## Usage in Code

### Automatic Logging

The system automatically logs authentication events:

```typescript
import { auditLogger } from '@/lib/audit-log'

// Login events are logged automatically in the auth context
await auditLogger.logUserLogin(
  currentUser.$id,
  sessionId,
  ipAddress,
  navigator.userAgent
)
```

### Manual Event Logging

Log custom events programmatically:

```typescript
import { auditLogger } from '@/lib/audit-log'

// Log security events
await auditLogger.logSecurityEvent(userId, 'SUSPICIOUS_ACTIVITY', {
  reason: 'Multiple failed login attempts',
  ipAddress: '192.168.1.1',
  attempts: 5
})

// Log system events
await auditLogger.logSystemEvent('BACKUP_COMPLETED', 'backup', {
  duration: '2.5s',
  size: '1.2GB',
  status: 'success'
})

// Log profile changes
await auditLogger.logProfileUpdate(userId, oldValues, newValues)
```

### Querying Audit Logs

Retrieve audit data for analysis:

```typescript
import { auditLogger } from '@/lib/audit-log'

// Get user's recent activity (last 50 events)
const userLogs = await auditLogger.getUserAuditLogs(userId, 50)

// Get recent system activity (last 100 events)
const recentLogs = await auditLogger.getRecentLogs(100)
```

## Rate Limiting

The audit logging system includes built-in rate limiting to prevent performance issues:

- **Write Operations**: 500ms minimum interval between log entries
- **Read Operations**: 1-second minimum interval between queries

## Implementation Details

### Singleton Pattern

The audit logger uses a singleton pattern for centralized logging:

```typescript
export class AuditLogger {
  private static instance: AuditLogger
  private lastFetchTime: number = 0
  private lastLogTime: number = 0

  static getInstance(): AuditLogger {
    if (!AuditLogger.instance) {
      AuditLogger.instance = new AuditLogger()
    }
    return AuditLogger.instance
  }
}

export const auditLogger = AuditLogger.getInstance()
```

### Error Handling

Audit logging failures don't break the main application flow:

```typescript
async log(entry: Omit<AuditLogEntry, 'id' | '$createdAt' | '$updatedAt'>): Promise<void> {
  try {
    await tablesDB.createRow({ /* ... */ })
  } catch (error) {
    console.error('Failed to create audit log:', error)
    // Don't throw - audit logging shouldn't break main functionality
  }
}
```

### Data Serialization

Complex objects are JSON-serialized for storage:

```typescript
data: {
  ...entry,
  oldValues: entry.oldValues ? JSON.stringify(entry.oldValues) : null,
  newValues: entry.newValues ? JSON.stringify(entry.newValues) : null,
  metadata: entry.metadata ? JSON.stringify(entry.metadata) : null,
}
```

## Monitoring & Analytics

### Security Monitoring

Use audit logs to monitor security:

```typescript
// Query failed login attempts
const failedLogins = await auditLogger.getRecentLogs(1000)
  .then(logs => logs.filter(log =>
    log.action === 'SECURITY_EVENT' &&
    log.metadata?.securityEvent === 'FAILED_LOGIN_ATTEMPT'
  ))
```

### Performance Analysis

Track system performance:

```typescript
// Analyze login patterns
const loginEvents = await auditLogger.getRecentLogs(1000)
  .then(logs => logs.filter(log => log.action === 'USER_LOGIN'))

const avgSessionTime = calculateAverageSessionTime(loginEvents)
```

## Troubleshooting

### Common Issues

**"Collection not found" error:**
- Verify the collection ID is exactly `audit_logs`
- Check database permissions
- Ensure the collection exists in your Appwrite project

**High latency on queries:**
- Add appropriate indexes as specified above
- Consider pagination for large result sets
- Check rate limiting is not blocking requests

**Missing audit events:**
- Verify the audit logger is properly imported
- Check console for audit logging errors
- Ensure database write permissions are correct

### Performance Optimization

For high-traffic applications:

1. **Implement pagination** for large audit log queries
2. **Use server-side filtering** instead of client-side
3. **Archive old logs** to separate collections
4. **Add more specific indexes** based on query patterns

## User-Specific Audit Logs

### Personal Activity Timeline

The audit logging system supports user-specific log retrieval for displaying personal activity timelines on the profile page.

**Implementation**: `lib/audit-log.ts`
- `getUserAuditLogs(userId, limit, offset)`: Fetches audit logs for a specific user
- Client-side filtering and sorting (due to Appwrite query limitations)
- Pagination support for large activity histories

**UI Component**: `components/app/auth/profile/personal-activity-timeline.tsx`
- Visual timeline UI with continuous vertical line and activity nodes
- Activity icons and badges for different event types
- Expandable view with pagination
- Real-time updates from audit logging system

**Supported Events**:
- `USER_LOGIN`, `USER_LOGOUT`
- `PROFILE_UPDATE`
- `EMAIL_VERIFIED`, `VERIFICATION_EMAIL_SENT`
- `PASSWORD_RESET`, `PASSWORD_RESET_REQUESTED`, `PASSWORD_RESET_FAILED`
- `SETTINGS_CHANGE`
- `SESSION_TERMINATED`
- All other audit events

## Related Documentation

- [Appwrite Setup Guide](./APPWRITE_SETUP.md) - Main Appwrite configuration
- [Architecture Overview](./ARCHITECTURE.md) - System architecture details
- [Authentication System](./AUTHENTICATION.md) - Authentication and security features
- [User Profile Schema](./APPWRITE_DB_USERS.md) - User profile database schema
- [Audit Logging Implementation](../../lib/audit-log.ts) - Source code implementation

## Next Steps

After setting up the audit logs collection:

1. ‚úÖ Test the audit logging functionality
2. üîÑ [Implement user profiles](../APPWRITE_SETUP.md#ready-for-implementation)
3. üîÑ Add real-time audit log updates
4. üîÑ Create audit log analytics dashboard
